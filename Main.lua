--LOADS SETTINGS--
local settings = {
	["DISABLE_ON_SEAT"] = false,
	["MAX_HEIGHT_ABOVE_GROUND"] = 15,
	["MAX_WALK_SPEED"] = 16,
	["MAX_OFFENSES"] = 5,
	["KICK_MESSAGE"] = "Max Offenses Reached."
}

warn("settings:",settings)

--SETTINGS ARE LOADED--
--//Variables\\--
local Players = game:GetService("Players")
local self = script
local controlEvent = Instance.new("BindableEvent",self)
controlEvent.Name = "controlEvent"

local playerList = {}

local pAdded = Players.PlayerAdded

local corCR = coroutine.create
local corRS = coroutine.resume
local m = math
local floor = m.floor
local ceil = m.ceil
local abs = m.abs
local clamp = m.clamp

--\\Variables//--

--PRIMARY FUNCTIONS--

function IPD(uid)
	return playerList[uid]
end

function NewInstance(player)
	local uid = player.UserId
	local character = player.Character or player.CharacterAdded:wait()
	local humanoid = character:WaitForChild("Humanoid",35)
	
	local offenses = 0
	
	local cor = nil
	
	cor = corCR(function()
		repeat
			wait()
			if offenses >= settings["MAX_OFFENSES"] then
				player:Kick(settings["KICK_MESSAGE"])
			end
		until not player
		return
	end)
	
	corRS(cor)
	
	--Walkspeed code
	cor = corCR(function()
		do
			local lastPosition = Vector3.new(0,0,0)
			local walkSpeed = settings["MAX_WALK_SPEED"]
			local tempDisable = false
			local start = true
			
			wait(1.5)
			if character:FindFirstChild("HumanoidRootPart") == nil then
				error("Character is missing humanoid root part")
				return
			end
			
			lastPosition = character:WaitForChild("HumanoidRootPart").Position
			
			humanoid.Died:connect(function()
				tempDisable = true
				wait(Players.RespawnTime+1)
				local root = character:WaitForChild("HumanoidRootPart",15)
				local rootpos = root.Position
				lastPosition = rootpos
				tempDisable = false
			end)
			
			repeat
				wait(1)
				if tempDisable == false then
					if start == true then
						lastPosition = character:WaitForChild("HumanoidRootPart").Position
						start = false
					end
					
					local root = character:WaitForChild("HumanoidRootPart",15)
					local rootpos = root.Position
					
					local lpos = Vector2.new(lastPosition.X,lastPosition.Z)
					local rpos = Vector2.new(rootpos.X,rootpos.Z)
					
					local dist = floor((lpos-rpos).Magnitude)
					if dist > walkSpeed+2 then
						warn(player.UserId.." - "..player.Name.." Offense || Walkspeed || "..dist.."studs || Current Offenses:"..offenses)
						offenses += 1
						root.Position = lastPosition
					else
						lastPosition = rootpos
					end
				end
			until not player
		end
	end)
	
	corRS(cor)
	
end

pAdded:Connect(function(plr)
	playerList[plr.UserId] = true
	plr.CharacterAppearanceLoaded:wait() -- waits until the characters appearance is fully loaded
	NewInstance(plr) -- just basically handles all the code keeping this function looking clean
end)

controlEvent.Event:Connect(function(...)
	local value,uid = table.unpack(...)
	
	if typeof(value) ~= "boolean" then
		error("expected boolean got "..typeof(value).." || control event || anti exploit")
	end
	
	playerList[uid] = value
end)