--[[
CHECK SCRIPT ATTRIBUTES FOR SETTINGS
]]--

--LOADS SETTINGS--
local settings = {}

for i,v in pairs(script:GetAttributes()) do
	settings[i] = v
end

warn("settings:",settings)

--SETTINGS ARE LOADED--
--//Variables\\--
local Players = game:GetService("Players")
local self = script
local controlEvent = Instance.new("BindableEvent",self)
controlEvent.Name = "controlEvent"

local playerList = {}

local pAdded = Players.PlayerAdded
--\\Variables//--

--PRIMARY FUNCTIONS--

function IPD(uid)
	return playerList[uid]
end

function NewInstance(player)
	local uid = player.UserId
	local character = player.Character or player.CharacterAdded:wait()
	local humanoid = character:WaitForChild("Humanoid",35)
	
	spawn(function()
		repeat
			wait()
		until not player
		return
	end)
	
	--Walkspeed code
	spawn(function()
		do
			local lastPosition = Vector3.new(0,0,0)
			local walkSpeed = settings["MAX_WALK_SPEED"]
			local tempDisable = false
			
			wait(1.5)
			if character:FindFirstChild("HumanoidRootPart") == nil then
				error("Character is missing humanoid root part")
				return
			end
			
			lastPosition = character:WaitForChild("HumanoidRootPart").Position
			
			humanoid.Died:connect(function()
				tempDisable = true
				wait(Players.RespawnTime+1)
				local root = character:WaitForChild("HumanoidRootPart",15)
				local rootpos = root.Position
				lastPosition = rootpos
				tempDisable = false
			end)
			
			repeat
				wait(1)
				if tempDisable == false then
					local root = character:WaitForChild("HumanoidRootPart",15)
					local rootpos = root.Position
					
					local lpos = Vector2.new(lastPosition.X,lastPosition.Z)
					local rpos = Vector2.new(rootpos.X,rootpos.Z)
					
					if (lpos-rpos).Magnitude > walkSpeed+4 then
						warn("player has moved to far, teleporting")
						root.Position = lastPosition
					else
						lastPosition = rootpos
					end
				end
			until not player
		end
	end)
	
	
end

pAdded:Connect(function(plr)
	playerList[plr.UserId] = true
	wait(5)
	NewInstance(plr) -- just basically handles all the code keeping this function looking clean
end)

controlEvent.Event:Connect(function(...)
	local value,uid = table.unpack(...)
	
	if typeof(value) ~= "boolean" then
		error("expected boolean got "..typeof(value).." || control event || anti exploit")
	end
	
	playerList[uid] = value
end)